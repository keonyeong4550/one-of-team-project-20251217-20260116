package com.desk.service;

import com.desk.dto.AIRequestDTO;
import com.desk.dto.AIResponseDTO;
import lombok.RequiredArgsConstructor;
import lombok.extern.log4j.Log4j2;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

@Service
@RequiredArgsConstructor
@Log4j2
public class AIServiceImpl implements AIService {

    // application.properties에서 값 주입
    @Value("${python.api.url}")
    private String pythonApiUrl;

    @Value("${python.api.key}")
    private String pythonApiKey;

    @Override
    public AIResponseDTO chatWithAI(AIRequestDTO requestDTO) {
        log.info("[AIService] Python AI 서버로 요청 전송 시작... (ConversationID: {})", requestDTO.getConversationId());

        try {
            // 1. 헤더 설정 (보안 키 포함)
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            headers.set("x-api-key", pythonApiKey); // Python: dependencies.py 검증용

            // 2. 요청 엔티티 생성 (Body + Header)
            HttpEntity<AIRequestDTO> entity = new HttpEntity<>(requestDTO, headers);

            // 3. RestTemplate으로 POST 요청 전송
            RestTemplate restTemplate = new RestTemplate();
            ResponseEntity<AIResponseDTO> response = restTemplate.postForEntity(
                    pythonApiUrl,
                    entity,
                    AIResponseDTO.class
            );

            log.info("[AIService] 응답 수신 성공 (Status: {})", response.getStatusCode());
            return response.getBody();

        } catch (Exception e) {
            log.error("[AIService] Python 서버 통신 중 오류 발생: {}", e.getMessage());
            throw new RuntimeException("AI Service Error: " + e.getMessage());
        }
    }
}